# Risk Manager V34 - Implementation Plan
## Architecture V2 + Project-X SDK Integration

**Created**: 2025-10-23
**Status**: Ready to Build
**Architecture**: v2 (SDK-Powered)

---

## ğŸ¯ Vision

Build the complete v2 architecture using Project-X SDK for all API/WebSocket heavy lifting:
- **SDK handles**: Auth, WebSocket, REST API, order/position management, event routing
- **We build**: 12 risk rules, lockout/timer management, state persistence, CLI

---

## ğŸ“Š What We Already Have

### âœ… Foundation (Phase 1 - COMPLETE)
- [x] Core structure (`RiskManager`, `RiskEngine`, `EventBus`)
- [x] 2 rules implemented (`DailyLossRule`, `MaxPositionRule`)
- [x] Basic SDK integration (`TradingIntegration` wrapper)
- [x] Examples and documentation
- [x] Git initialized

**Files**: `src/risk_manager/core/*.py`, `src/risk_manager/rules/*.py`

---

## ğŸ—ï¸ SDK Integration Mapping

### What the SDK Provides (Already Working)

| Feature | SDK Component | Location in SDK |
|---------|---------------|-----------------|
| **Authentication** | `ProjectX.client` | Auto-handled on create |
| **WebSocket Events** | `ProjectXRealtimeClient` | Realtime subscriptions |
| **REST API** | `ProjectX` methods | `await client.get_*()` / `post_*()` |
| **Close Positions** | `PositionManager.close_*()` | Built-in enforcement |
| **Cancel Orders** | `OrderManager.cancel_*()` | Built-in enforcement |
| **P&L Tracking** | `PositionManager.get_pnl()` | Real-time analytics |
| **Event Routing** | `EventBus` | Built-in pub/sub |
| **Connection Management** | `TradingSuite` | Auto-reconnect |

**SDK Location**: `C:\Users\jakers\Desktop\SDK RM\project-x-py\src\project_x_py\`

### What We Build (Custom Logic)

| Component | Purpose | Status |
|-----------|---------|--------|
| **12 Risk Rules** | Business logic for each rule | 2/12 done |
| **Lockout Manager** | State management for lockouts | To build |
| **Timer Manager** | Countdown timers for cooldowns | To build |
| **Reset Scheduler** | Daily resets at configured time | To build |
| **State Persistence** | SQLite for crash recovery | To build |
| **CLI Interfaces** | Admin + Trader UIs | To build |

---

## ğŸš€ Phase Breakdown

### Phase 2: SDK Integration Enhancement (Week 1)
**Goal**: Strengthen SDK integration and add 4 more rules

#### 2.1 Enhance SDK Wrapper
- [ ] Create `src/risk_manager/sdk/suite_manager.py`
  - Manage TradingSuite lifecycle
  - Handle multiple instruments
  - Reconnection logic

- [ ] Create `src/risk_manager/sdk/enforcement.py`
  - Wrapper for SDK's PositionManager/OrderManager
  - Standardized enforcement interface
  - Error handling and retries

- [ ] Create `src/risk_manager/sdk/event_bridge.py`
  - Bridge SDK EventBus to our RiskEngine
  - Map SDK events to RiskEvents
  - Event filtering and routing

#### 2.2 Implement 4 Priority Rules
Using SDK's real-time data and enforcement:

- [ ] **RULE-002**: Max Contracts Per Instrument
  - Use: `PositionManager.get_positions_by_instrument()`
  - Enforce: `PositionManager.close_position(contract_id)`

- [ ] **RULE-004**: Daily Unrealized Loss
  - Use: `PositionManager.get_unrealized_pnl()`
  - Enforce: `PositionManager.close_all_positions()`

- [ ] **RULE-006**: Trade Frequency Limit
  - Use: SDK's `GatewayUserTrade` events
  - Track: Trade history with timestamps
  - Enforce: Lockout mechanism

- [ ] **RULE-009**: Session Block Outside Hours
  - Use: SDK's market data for time validation
  - Track: Session start/end times
  - Enforce: Close positions + lockout

**Files to Create**:
```
src/risk_manager/
â”œâ”€â”€ sdk/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ suite_manager.py      # TradingSuite lifecycle
â”‚   â”œâ”€â”€ enforcement.py         # SDK enforcement wrapper
â”‚   â””â”€â”€ event_bridge.py        # Event routing bridge
â”œâ”€â”€ rules/
â”‚   â”œâ”€â”€ max_contracts_per_instrument.py
â”‚   â”œâ”€â”€ daily_unrealized_loss.py
â”‚   â”œâ”€â”€ trade_frequency_limit.py
â”‚   â””â”€â”€ session_block_outside.py
```

---

### Phase 3: State Management (Week 2)
**Goal**: Implement the 4 core modules (MOD-002, 003, 004) + persistence

#### 3.1 Lockout Manager (MOD-002)
- [ ] Create `src/risk_manager/state/lockout_manager.py`
  - Set/clear lockouts with expiry
  - Check lockout status
  - Auto-clear expired lockouts
  - Integration with rules

#### 3.2 Timer Manager (MOD-003)
- [ ] Create `src/risk_manager/state/timer_manager.py`
  - Countdown timers with callbacks
  - Get remaining time
  - Cancel/restart timers
  - Background timer checking

#### 3.3 Reset Scheduler (MOD-004)
- [ ] Create `src/risk_manager/state/reset_scheduler.py`
  - Daily reset at configured time
  - Holiday calendar integration
  - Reset all daily counters (P&L, trades)
  - Timezone handling

#### 3.4 State Persistence
- [ ] Create `src/risk_manager/state/persistence.py`
  - SQLite database setup
  - Save/load state (lockouts, timers, counters)
  - Automatic backups
  - Crash recovery

**Files to Create**:
```
src/risk_manager/state/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ lockout_manager.py
â”œâ”€â”€ timer_manager.py
â”œâ”€â”€ reset_scheduler.py
â””â”€â”€ persistence.py

data/
â”œâ”€â”€ state.db              # SQLite database
â””â”€â”€ backups/              # Auto backups
```

---

### Phase 4: Remaining Rules (Week 3)
**Goal**: Implement remaining 6 rules

- [ ] **RULE-005**: Max Unrealized Profit (take profit)
- [ ] **RULE-007**: Cooldown After Loss
- [ ] **RULE-008**: No Stop Loss Grace Period
- [ ] **RULE-010**: Auth Loss Guard
- [ ] **RULE-011**: Symbol Blocks (whitelist/blacklist)
- [ ] **RULE-012**: Trade Management (auto stop-loss/take-profit)

**Integration Points**:
- All use SDK for data (positions, orders, trades)
- All use `LockoutManager` for state
- All use `TimerManager` for cooldowns
- All use `Persistence` for crash recovery

---

### Phase 5: CLI Interfaces (Week 4)
**Goal**: Build admin and trader CLIs

#### 5.1 Admin CLI
- [ ] Create `src/risk_manager/cli/admin/`
  - Password authentication
  - Rule configuration wizard
  - Service control (start/stop/restart)
  - Manual lockout override
  - View logs and state

#### 5.2 Trader CLI
- [ ] Create `src/risk_manager/cli/trader/`
  - Real-time status screen
  - Lockout timer display
  - P&L dashboard
  - Recent enforcement log
  - Clock in/out tracking

**UI Framework**: Use `rich` library (already in dependencies)

---

### Phase 6: Service & Production (Week 5)
**Goal**: Production deployment

#### 6.1 Windows Service
- [ ] Create `src/risk_manager/service/`
  - Windows service wrapper
  - Service installer
  - Auto-restart on crash
  - Service configuration

#### 6.2 Production Features
- [ ] Comprehensive logging (daemon, enforcement, API, errors)
- [ ] Health monitoring and metrics
- [ ] Alert system (Discord/Telegram/Email)
- [ ] Performance optimization
- [ ] Full test coverage (>90%)

---

## ğŸ”Œ SDK Event Flow

```
1. Trader places order in broker
       â†“
2. TopstepX Gateway processes
       â†“
3. Project-X SDK WebSocket receives event
   (ProjectXRealtimeClient)
       â†“
4. SDK EventBus publishes event
       â†“
5. Our event_bridge.py receives
       â†“
6. RiskEngine routes to relevant rules
       â†“
7. Rules evaluate breach condition
   (using SDK data: positions, P&L, etc.)
       â†“
8. If breach: Call enforcement.py
       â†“
9. enforcement.py uses SDK:
   - PositionManager.close_all_positions()
   - OrderManager.cancel_all_orders()
       â†“
10. LockoutManager sets lockout state
       â†“
11. Persistence saves to SQLite
       â†“
12. Trader CLI updates display
```

---

## ğŸ› ï¸ Development Workflow

### 1. Environment Setup
```bash
# Already done, but verify:
cd C:\Users\jakers\Desktop\risk-manager-v34
uv sync
uv run python -c "from risk_manager import RiskManager; print('âœ…')"
```

### 2. SDK Exploration
```bash
# SDK is here (editable):
cd "C:\Users\jakers\Desktop\SDK RM\project-x-py"

# Key files to reference:
# - src/project_x_py/trading_suite.py (main entry)
# - src/project_x_py/position_manager/core.py (positions)
# - src/project_x_py/order_manager/core.py (orders)
# - src/project_x_py/realtime/core.py (WebSocket)
# - src/project_x_py/event_bus.py (events)
```

### 3. Incremental Development
- Build one component at a time
- Test each component independently
- Integrate with SDK gradually
- Keep examples updated

### 4. Testing Strategy
```bash
# Unit tests (mock SDK)
uv run pytest tests/unit/

# Integration tests (real SDK,)
uv run pytest tests/integration/

# Manual testing
uv run python examples/04_sdk_enforcement.py
```

---

## ğŸ“‹ Implementation Checklist

### Immediate Next Steps (This Week)
- [ ] Create `sdk/` module structure
- [ ] Build `suite_manager.py` (TradingSuite wrapper)
- [ ] Build `enforcement.py` (SDK enforcement wrapper)
- [ ] Build `event_bridge.py` (Event routing)
- [ ] Implement RULE-002 (Max Contracts Per Instrument)
- [ ] Test with paper trading account

### Week 1 Goals
- [ ] 4 rules implemented (RULE-002, 004, 006, 009)
- [ ] SDK integration solid
- [ ] Event flow working end-to-end
- [ ] Example showing full workflow

### Week 2 Goals
- [ ] All 4 modules (MOD-002, 003, 004 + persistence)
- [ ] State management working
- [ ] Lockouts and timers functional
- [ ] Daily reset scheduler working

### Week 3 Goals
- [ ] Remaining 6 rules (RULE-005, 007, 008, 010, 011, 012)
- [ ] All 12 rules tested
- [ ] Comprehensive test coverage

### Week 4 Goals
- [ ] Admin CLI complete
- [ ] Trader CLI complete
- [ ] Real-time UI working

### Week 5 Goals
- [ ] Windows service ready
- [ ] Production deployment
- [ ] Documentation complete
- [ ] Go live! ğŸš€

---

## ğŸ“ Learning Resources

### SDK Documentation
- **README**: `C:\Users\jakers\Desktop\SDK RM\project-x-py\README.md`
- **Examples**: `C:\Users\jakers\Desktop\SDK RM\project-x-py\examples\`
- **Source Code**: `C:\Users\jakers\Desktop\SDK RM\project-x-py\src\`

### Architecture Docs
- **v2 Architecture**: `docs/PROJECT_DOCS/architecture/system_architecture_v2.md`
- **Rule Specs**: `docs/PROJECT_DOCS/rules/*.md` (12 rules)
- **Module Specs**: `docs/PROJECT_DOCS/modules/*.md` (4 modules)

### Current Implementation
- **Core**: `src/risk_manager/core/`
- **Rules**: `src/risk_manager/rules/`
- **Examples**: `examples/`

---

## ğŸ¯ Success Criteria

You're production-ready when:
- [x] Foundation complete âœ…
- [ ] All 12 rules implemented
- [ ] All 4 modules working
- [ ] State persistence reliable
- [ ] CLI interfaces functional
- [ ] Windows service deployed
- [ ] Tests passing (>90% coverage)
- [ ] Connected to live trading account
- [ ] Protecting capital in production! ğŸ›¡ï¸

---

## ğŸ’¡ Key Advantages of SDK Integration

1. **Less Code**: SDK handles 60% of architecture v2
2. **Battle-Tested**: SDK is production-proven
3. **Maintained**: SDK gets updates/fixes automatically
4. **Type-Safe**: SDK has full type hints
5. **Async-First**: Perfect for real-time trading
6. **Performance**: Optimized WebSocket/HTTP handling

---

## ğŸ¤ Next Steps

1. **Review this plan**
2. **Start Phase 2.1**: Build SDK wrapper layer
3. **Implement RULE-002** as first test case
4. **Iterate and test** with paper trading
5. **Build incrementally** following phases

---

**Questions?** Check the docs or let's build! ğŸš€

**Ready to protect your trading capital with architecture v2?** Let's start with Phase 2! ğŸ›¡ï¸
