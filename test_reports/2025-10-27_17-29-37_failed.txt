================================================================================
Risk Manager V34 - Test Report
================================================================================
Test Run: Unit tests only
Timestamp: 2025-10-27 17:29:37
Status: FAILED
Exit Code: 1
================================================================================

Using CPython 3.13.7
Removed virtual environment at: .venv
Creating virtual environment at: .venv
warning: Failed to hardlink files; falling back to full copy. This may lead to degraded performance.
         If the cache and target directories are on different filesystems, hardlinking may not be supported.
         If this is intentional, set `export UV_LINK_MODE=copy` or use `--link-mode=copy` to suppress this warning.
Installed 57 packages in 17.45s
[1m============================= test session starts ==============================[0m
platform linux -- Python 3.13.7, pytest-8.4.2, pluggy-1.6.0 -- /mnt/c/Users/jakers/Desktop/risk-manager-v34/.venv/bin/python
cachedir: .pytest_cache
rootdir: /mnt/c/Users/jakers/Desktop/risk-manager-v34
configfile: pyproject.toml
plugins: anyio-4.11.0, asyncio-1.2.0, cov-7.0.0, mock-3.15.1
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
[1mcollecting ... [0mcollected 95 items

tests/unit/test_core/test_enforcement_wiring.py::TestEnforcementWiring::test_engine_accepts_trading_integration [32mPASSED[0m[33m [  1%][0m
tests/unit/test_core/test_enforcement_wiring.py::TestEnforcementWiring::test_flatten_all_calls_trading_integration [32mPASSED[0m[33m [  2%][0m
tests/unit/test_core/test_enforcement_wiring.py::TestEnforcementWiring::test_flatten_all_without_trading_integration [32mPASSED[0m[33m [  3%][0m
tests/unit/test_core/test_enforcement_wiring.py::TestEnforcementWiring::test_enforcement_from_violation [32mPASSED[0m[33m [  4%][0m
tests/unit/test_core/test_events.py::TestEventBus::test_create_event_bus [32mPASSED[0m[33m [  5%][0m
tests/unit/test_core/test_events.py::TestEventBus::test_subscribe_to_event [32mPASSED[0m[33m [  6%][0m
tests/unit/test_core/test_events.py::TestEventBus::test_subscribe_multiple_callbacks [32mPASSED[0m[33m [  7%][0m
tests/unit/test_core/test_events.py::TestEventBus::test_unsubscribe_from_event [32mPASSED[0m[33m [  8%][0m
tests/unit/test_core/test_events.py::TestRiskEvent::test_create_event [32mPASSED[0m[33m [  9%][0m
tests/unit/test_core/test_events.py::TestRiskEvent::test_event_has_timestamp [32mPASSED[0m[33m [ 10%][0m
tests/unit/test_core/test_events.py::TestEventType::test_event_types_exist [32mPASSED[0m[33m [ 11%][0m
tests/unit/test_rules/test_max_position_rule.py::TestMaxPositionRuleUnit::test_rule_initialization [32mPASSED[0m[33m [ 12%][0m
tests/unit/test_rules/test_max_position_rule.py::TestMaxPositionRuleUnit::test_rule_initialization_custom_action [32mPASSED[0m[33m [ 13%][0m
tests/unit/test_rules/test_max_position_rule.py::TestMaxPositionRuleUnit::test_position_below_limit_passes [32mPASSED[0m[33m [ 14%][0m
tests/unit/test_rules/test_max_position_rule.py::TestMaxPositionRuleUnit::test_zero_position_passes [32mPASSED[0m[33m [ 15%][0m
tests/unit/test_rules/test_max_position_rule.py::TestMaxPositionRuleUnit::test_position_at_limit_passes [32mPASSED[0m[33m [ 16%][0m
tests/unit/test_rules/test_max_position_rule.py::TestMaxPositionRuleUnit::test_position_exceeds_limit_violates [32mPASSED[0m[33m [ 17%][0m
tests/unit/test_rules/test_max_position_rule.py::TestMaxPositionRuleUnit::test_large_position_violates [32mPASSED[0m[33m [ 18%][0m
tests/unit/test_rules/test_max_position_rule.py::TestMaxPositionRuleUnit::test_multi_symbol_total_below_limit [32mPASSED[0m[33m [ 20%][0m
tests/unit/test_rules/test_max_position_rule.py::TestMaxPositionRuleUnit::test_multi_symbol_total_exceeds_limit [32mPASSED[0m[33m [ 21%][0m
tests/unit/test_rules/test_max_position_rule.py::TestMaxPositionRuleUnit::test_short_position_below_limit [32mPASSED[0m[33m [ 22%][0m
tests/unit/test_rules/test_max_position_rule.py::TestMaxPositionRuleUnit::test_short_position_exceeds_limit [32mPASSED[0m[33m [ 23%][0m
tests/unit/test_rules/test_max_position_rule.py::TestMaxPositionRuleUnit::test_flatten_action_in_violation [32mPASSED[0m[33m [ 24%][0m
tests/unit/test_rules/test_max_position_rule.py::TestMaxPositionRuleUnit::test_reject_action_in_violation [32mPASSED[0m[33m [ 25%][0m
tests/unit/test_rules/test_max_position_rule.py::TestMaxPositionRuleUnit::test_only_evaluates_position_events [32mPASSED[0m[33m [ 26%][0m
tests/unit/test_rules/test_max_position_rule.py::TestMaxPositionRuleUnit::test_evaluates_order_filled_event [32mPASSED[0m[33m [ 27%][0m
tests/unit/test_rules/test_max_position_rule.py::TestMaxPositionRuleUnit::test_negative_limit_raises_error [32mPASSED[0m[33m [ 28%][0m
tests/unit/test_rules/test_max_position_rule.py::TestMaxPositionRuleUnit::test_zero_limit [32mPASSED[0m[33m [ 29%][0m
tests/unit/test_rules/test_max_position_rule.py::TestMaxPositionRuleUnit::test_missing_position_data [32mPASSED[0m[33m [ 30%][0m
tests/unit/test_rules/test_max_position_rule.py::TestMaxPositionRuleUnit::test_violation_message_clarity [32mPASSED[0m[33m [ 31%][0m
tests/unit/test_state/test_lockout_manager.py::TestHardLockoutOperations::test_set_lockout_locks_account [32mPASSED[0m[33m [ 32%][0m
tests/unit/test_state/test_lockout_manager.py::TestHardLockoutOperations::test_is_locked_out_returns_true_when_locked [32mPASSED[0m[33m [ 33%][0m
tests/unit/test_state/test_lockout_manager.py::TestHardLockoutOperations::test_is_locked_out_returns_false_when_not_locked [32mPASSED[0m[33m [ 34%][0m
tests/unit/test_state/test_lockout_manager.py::TestHardLockoutOperations::test_get_lockout_info_returns_details [32mPASSED[0m[33m [ 35%][0m
tests/unit/test_state/test_lockout_manager.py::TestHardLockoutOperations::test_get_lockout_info_returns_none_when_not_locked [32mPASSED[0m[33m [ 36%][0m
tests/unit/test_state/test_lockout_manager.py::TestHardLockoutOperations::test_clear_lockout_removes_lockout [32mPASSED[0m[33m [ 37%][0m
tests/unit/test_state/test_lockout_manager.py::TestCooldownTimers::test_set_cooldown_creates_timer [32mPASSED[0m[33m [ 38%][0m
tests/unit/test_state/test_lockout_manager.py::TestCooldownTimers::test_cooldown_auto_expires_after_duration [31mFAILED[0m[31m [ 40%][0m
tests/unit/test_state/test_lockout_manager.py::TestCooldownTimers::test_cooldown_remaining_time_decreases [32mPASSED[0m[31m [ 41%][0m
tests/unit/test_state/test_lockout_manager.py::TestCooldownTimers::test_cooldown_cleared_cancels_timer [31mFAILED[0m[31m [ 42%][0m
tests/unit/test_state/test_lockout_manager.py::TestCooldownTimers::test_cooldown_integrates_with_timer_manager [32mPASSED[0m[31m [ 43%][0m
tests/unit/test_state/test_lockout_manager.py::TestBackgroundTask::test_check_expired_lockouts_runs_every_second [32mPASSED[0m[31m [ 44%][0m
tests/unit/test_state/test_lockout_manager.py::TestBackgroundTask::test_expired_lockout_auto_cleared [31mFAILED[0m[31m [ 45%][0m
tests/unit/test_state/test_lockout_manager.py::TestBackgroundTask::test_background_task_stops_on_shutdown [32mPASSED[0m[31m [ 46%][0m
tests/unit/test_state/test_lockout_manager.py::TestMultipleAccounts::test_multiple_accounts_locked_independently [32mPASSED[0m[31m [ 47%][0m
tests/unit/test_state/test_lockout_manager.py::TestMultipleAccounts::test_lockout_affects_only_target_account [32mPASSED[0m[31m [ 48%][0m
tests/unit/test_state/test_lockout_manager.py::TestMultipleAccounts::test_clear_lockout_affects_only_target_account [32mPASSED[0m[31m [ 49%][0m
tests/unit/test_state/test_lockout_manager.py::TestDatabasePersistence::test_lockout_saved_to_database [32mPASSED[0m[31m [ 50%][0m
tests/unit/test_state/test_lockout_manager.py::TestDatabasePersistence::test_lockout_deleted_from_database_on_clear [32mPASSED[0m[31m [ 51%][0m
tests/unit/test_state/test_lockout_manager.py::TestDatabasePersistence::test_load_lockouts_populates_memory_state [32mPASSED[0m[31m [ 52%][0m
tests/unit/test_state/test_lockout_manager.py::TestDatabasePersistence::test_expired_lockout_removed_from_database [32mPASSED[0m[31m [ 53%][0m
tests/unit/test_state/test_lockout_manager.py::TestDatabasePersistence::test_database_schema_correct [32mPASSED[0m[31m [ 54%][0m
tests/unit/test_state/test_lockout_manager.py::TestEdgeCases::test_lockout_until_past_time_immediately_expired [32mPASSED[0m[31m [ 55%][0m
tests/unit/test_state/test_lockout_manager.py::TestEdgeCases::test_lockout_reason_persisted_correctly [32mPASSED[0m[31m [ 56%][0m
tests/unit/test_state/test_lockout_manager.py::TestEdgeCases::test_double_lockout_overwrites_previous [32mPASSED[0m[31m [ 57%][0m
tests/unit/test_state/test_lockout_manager.py::TestEventRouterIntegration::test_locked_account_blocks_rule_processing [32mPASSED[0m[31m [ 58%][0m
tests/unit/test_state/test_lockout_manager.py::TestEventRouterIntegration::test_unlocked_account_allows_rule_processing [32mPASSED[0m[31m [ 60%][0m
tests/unit/test_state/test_lockout_manager.py::TestLockoutTypes::test_hard_lockout_type_stored_correctly [32mPASSED[0m[31m [ 61%][0m
tests/unit/test_state/test_lockout_manager.py::TestLockoutTypes::test_cooldown_type_stored_correctly [32mPASSED[0m[31m [ 62%][0m
tests/unit/test_state/test_lockout_manager.py::TestStartupShutdown::test_lockouts_restored_on_startup [32mPASSED[0m[31m [ 63%][0m
tests/unit/test_state/test_lockout_manager.py::TestStartupShutdown::test_shutdown_cancels_all_timers [32mPASSED[0m[31m [ 64%][0m
tests/unit/test_state/test_pnl_tracker.py::TestPnLTrackerBasics::test_tracker_initializes [32mPASSED[0m[31m [ 65%][0m
tests/unit/test_state/test_pnl_tracker.py::TestPnLTrackerBasics::test_get_daily_pnl_returns_zero_for_new_account [32mPASSED[0m[31m [ 66%][0m
tests/unit/test_state/test_pnl_tracker.py::TestPnLTrackerBasics::test_add_trade_pnl_updates_daily_total [32mPASSED[0m[31m [ 67%][0m
tests/unit/test_state/test_pnl_tracker.py::TestPnLTrackerPersistence::test_pnl_survives_restart [32mPASSED[0m[31m [ 68%][0m
tests/unit/test_state/test_pnl_tracker.py::TestPnLTrackerPersistence::test_multiple_accounts_tracked_independently [32mPASSED[0m[31m [ 69%][0m
tests/unit/test_state/test_pnl_tracker.py::TestPnLTrackerReset::test_reset_clears_daily_pnl [32mPASSED[0m[31m [ 70%][0m
tests/unit/test_state/test_pnl_tracker.py::TestPnLTrackerReset::test_different_dates_tracked_separately [32mPASSED[0m[31m [ 71%][0m
tests/unit/test_state/test_pnl_tracker.py::TestPnLTrackerTradeCount::test_trade_count_increments [32mPASSED[0m[31m [ 72%][0m
tests/unit/test_state/test_pnl_tracker.py::TestPnLTrackerTradeCount::test_trade_count_resets_with_pnl [32mPASSED[0m[31m [ 73%][0m
tests/unit/test_state/test_pnl_tracker.py::TestPnLTrackerEdgeCases::test_handles_zero_pnl_trades [32mPASSED[0m[31m [ 74%][0m
tests/unit/test_state/test_pnl_tracker.py::TestPnLTrackerEdgeCases::test_handles_large_pnl_values [32mPASSED[0m[31m [ 75%][0m
tests/unit/test_state/test_pnl_tracker.py::TestPnLTrackerEdgeCases::test_get_all_account_pnls [32mPASSED[0m[31m [ 76%][0m
tests/unit/test_state/test_timer_manager.py::test_start_timer_creates_timer [32mPASSED[0m[31m [ 77%][0m
tests/unit/test_state/test_timer_manager.py::test_get_remaining_time_decreases [32mPASSED[0m[31m [ 78%][0m
tests/unit/test_state/test_timer_manager.py::test_cancel_timer_removes_timer [32mPASSED[0m[31m [ 80%][0m
tests/unit/test_state/test_timer_manager.py::test_expired_timer_executes_callback [32mPASSED[0m[31m [ 81%][0m
tests/unit/test_state/test_timer_manager.py::test_expired_timer_auto_removed [32mPASSED[0m[31m [ 82%][0m
tests/unit/test_state/test_timer_manager.py::test_multiple_timers_run_simultaneously [32mPASSED[0m[31m [ 83%][0m
tests/unit/test_state/test_timer_manager.py::test_timers_expire_independently [32mPASSED[0m[31m [ 84%][0m
tests/unit/test_state/test_timer_manager.py::test_cancel_specific_timer_preserves_others [32mPASSED[0m[31m [ 85%][0m
tests/unit/test_state/test_timer_manager.py::test_callback_receives_correct_context [32mPASSED[0m[31m [ 86%][0m
tests/unit/test_state/test_timer_manager.py::test_callback_exception_doesnt_crash_manager [32mPASSED[0m[31m [ 87%][0m
tests/unit/test_state/test_timer_manager.py::test_callback_executes_exactly_once [32mPASSED[0m[31m [ 88%][0m
tests/unit/test_state/test_timer_manager.py::test_async_callback_supported [32mPASSED[0m[31m [ 89%][0m
tests/unit/test_state/test_timer_manager.py::test_zero_duration_timer_executes_immediately [32mPASSED[0m[31m [ 90%][0m
tests/unit/test_state/test_timer_manager.py::test_negative_duration_raises_error [32mPASSED[0m[31m [ 91%][0m
tests/unit/test_state/test_timer_manager.py::test_timer_precision_within_tolerance [32mPASSED[0m[31m [ 92%][0m
tests/unit/test_state/test_timer_manager.py::test_check_timers_runs_every_second [32mPASSED[0m[31m [ 93%][0m
tests/unit/test_state/test_timer_manager.py::test_check_timers_stops_on_shutdown [32mPASSED[0m[31m [ 94%][0m
tests/unit/test_state/test_timer_manager.py::test_get_remaining_time_nonexistent_timer_returns_zero [32mPASSED[0m[31m [ 95%][0m
tests/unit/test_state/test_timer_manager.py::test_cancel_nonexistent_timer_no_error [32mPASSED[0m[31m [ 96%][0m
tests/unit/test_state/test_timer_manager.py::test_duplicate_timer_name_overwrites_previous [32mPASSED[0m[31m [ 97%][0m
tests/unit/test_state/test_timer_manager.py::test_has_timer_returns_false_for_nonexistent [32mPASSED[0m[31m [ 98%][0m
tests/unit/test_state/test_timer_manager.py::test_start_timer_without_callback_raises_error [32mPASSED[0m[31m [100%][0m

=================================== FAILURES ===================================
[31m[1m_________ TestCooldownTimers.test_cooldown_auto_expires_after_duration _________[0m
[1m[31mtests/unit/test_state/test_lockout_manager.py[0m:223: in test_cooldown_auto_expires_after_duration
    [0m[94massert[39;49;00m lockout_manager.is_locked_out(account_id) [95mis[39;49;00m [94mFalse[39;49;00m[90m[39;49;00m
[1m[31mE   assert True is False[0m
[1m[31mE    +  where True = is_locked_out(123)[0m
[1m[31mE    +    where is_locked_out = <risk_manager.state.lockout_manager.LockoutManager object at 0x78116a461260>.is_locked_out[0m
------------------------------ Captured log setup ------------------------------
[32mINFO    [0m root:conftest.py:37 Applying schema migration: v1 (initial schema)

[32mINFO    [0m root:conftest.py:37 Schema v1 applied successfully

[32mINFO    [0m root:conftest.py:37 Database initialized at /tmp/tmp7yrqf4hp.db

[32mINFO    [0m root:conftest.py:37 Loaded 0 lockouts from database

[32mINFO    [0m root:conftest.py:37 Lockout Manager initialized
------------------------------ Captured log call -------------------------------
[32mINFO    [0m root:conftest.py:37 Timer Manager unavailable, using background task fallback: TestCooldownTimers.test_cooldown_auto_expires_after_duration.<locals>.mock_start_timer() got an unexpected keyword argument 'duration'

[32mINFO    [0m root:conftest.py:37 Account 123 cooldown for 1800s: Test
---------------------------- Captured log teardown -----------------------------
[32mINFO    [0m root:conftest.py:37 Database closed
[31m[1m____________ TestCooldownTimers.test_cooldown_cleared_cancels_timer ____________[0m
[1m[31mtests/unit/test_state/test_lockout_manager.py[0m:260: in test_cooldown_cleared_cancels_timer
    [0m[94mawait[39;49;00m lockout_manager.clear_lockout(account_id)[90m[39;49;00m
[1m[31mE   TypeError: object NoneType can't be used in 'await' expression[0m
------------------------------ Captured log setup ------------------------------
[32mINFO    [0m root:conftest.py:37 Applying schema migration: v1 (initial schema)

[32mINFO    [0m root:conftest.py:37 Schema v1 applied successfully

[32mINFO    [0m root:conftest.py:37 Database initialized at /tmp/tmpk8gr3pqz.db

[32mINFO    [0m root:conftest.py:37 Loaded 0 lockouts from database

[32mINFO    [0m root:conftest.py:37 Lockout Manager initialized
------------------------------ Captured log call -------------------------------
[32mINFO    [0m root:conftest.py:37 Timer started for account 123 cooldown

[32mINFO    [0m root:conftest.py:37 Account 123 cooldown for 1800s: Test

[32mINFO    [0m root:conftest.py:37 Lockout cleared for account 123: Test
---------------------------- Captured log teardown -----------------------------
[32mINFO    [0m root:conftest.py:37 Database closed
[31m[1m_____________ TestBackgroundTask.test_expired_lockout_auto_cleared _____________[0m
[1m[31mtests/unit/test_state/test_lockout_manager.py[0m:340: in test_expired_lockout_auto_cleared
    [0m[94massert[39;49;00m lockout_manager.is_locked_out(account_id) [95mis[39;49;00m [94mTrue[39;49;00m[90m[39;49;00m
[1m[31mE   assert False is True[0m
[1m[31mE    +  where False = is_locked_out(123)[0m
[1m[31mE    +    where is_locked_out = <risk_manager.state.lockout_manager.LockoutManager object at 0x78116a221ef0>.is_locked_out[0m
------------------------------ Captured log setup ------------------------------
[32mINFO    [0m root:conftest.py:37 Applying schema migration: v1 (initial schema)

[32mINFO    [0m root:conftest.py:37 Schema v1 applied successfully

[32mINFO    [0m root:conftest.py:37 Database initialized at /tmp/tmps5260t9o.db

[32mINFO    [0m root:conftest.py:37 Loaded 0 lockouts from database

[32mINFO    [0m root:conftest.py:37 Lockout Manager initialized
------------------------------ Captured log call -------------------------------
[32mINFO    [0m root:conftest.py:37 Account 123 locked until 2025-10-27T22:28:10.194723+00:00: Test

[32mINFO    [0m root:conftest.py:37 Lockout cleared for account 123: Test
---------------------------- Captured log teardown -----------------------------
[32mINFO    [0m root:conftest.py:37 Database closed
[33m=============================== warnings summary ===============================[0m
.venv/lib/python3.13/site-packages/uvloop/__init__.py:154
  /mnt/c/Users/jakers/Desktop/risk-manager-v34/.venv/lib/python3.13/site-packages/uvloop/__init__.py:154: DeprecationWarning: uvloop.install() is deprecated in favor of uvloop.run() starting with Python 3.12.
    _warnings.warn(

tests/unit/test_state/test_lockout_manager.py: 31 warnings
tests/unit/test_state/test_pnl_tracker.py: 12 warnings
  /mnt/c/Users/jakers/Desktop/risk-manager-v34/src/risk_manager/state/database.py:82: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    (1, datetime.utcnow().isoformat()),

tests/unit/test_state/test_lockout_manager.py::TestCooldownTimers::test_cooldown_cleared_cancels_timer
  /mnt/c/Users/jakers/Desktop/risk-manager-v34/src/risk_manager/state/lockout_manager.py:394: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    self.timer_manager.cancel_timer(f"lockout_{account_id}")
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/test_state/test_pnl_tracker.py: 23 warnings
  /mnt/c/Users/jakers/Desktop/risk-manager-v34/src/risk_manager/state/pnl_tracker.py:63: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    now = datetime.utcnow().isoformat()

tests/unit/test_state/test_pnl_tracker.py::TestPnLTrackerReset::test_reset_clears_daily_pnl
tests/unit/test_state/test_pnl_tracker.py::TestPnLTrackerTradeCount::test_trade_count_resets_with_pnl
  /mnt/c/Users/jakers/Desktop/risk-manager-v34/src/risk_manager/state/pnl_tracker.py:194: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    now = datetime.utcnow().isoformat()

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
[36m[1m=========================== short test summary info ============================[0m
[31mFAILED[0m tests/unit/test_state/test_lockout_manager.py::[1mTestCooldownTimers::test_cooldown_auto_expires_after_duration[0m - assert True is False
[31mFAILED[0m tests/unit/test_state/test_lockout_manager.py::[1mTestCooldownTimers::test_cooldown_cleared_cancels_timer[0m - TypeError: object NoneType can't be used in 'await' expression
[31mFAILED[0m tests/unit/test_state/test_lockout_manager.py::[1mTestBackgroundTask::test_expired_lockout_auto_cleared[0m - assert False is True
[31m============= [31m[1m3 failed[0m, [32m92 passed[0m, [33m70 warnings[0m[31m in 89.54s (0:01:29)[0m[31m =============[0m


================================================================================
End of Report
================================================================================
